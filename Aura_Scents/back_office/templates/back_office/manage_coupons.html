{% extends "back_office/base.html" %}

{% block title %}Manage Coupons - Perfume Store{% endblock %}

{% block page_title %}Manage Coupons{% endblock %}

{% block content %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Local Styling -->
<style>
.form-group {
margin-bottom: 20px;
}

.form-group input[type="text"],
.form-group input[type="number"],
.form-group input[type="datetime-local"],
.form-group select,
.form-group textarea {
max-width: 400px;
width: 100%;
padding: 10px 12px;
border: 1px solid #ccc;
border-radius: 8px;
font-size: 16px;
background-color: #f9f9f9;
appearance: none;
-webkit-appearance: none;
-moz-appearance: none;
}

.form-group select {
background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D'http%3A//www.w3.org/2000/svg'%20viewBox%3D'0%200%204%205'%3E%3Cpath%20fill%3D'%23333'%20d%3D'M2%200L0%202h4L2%200zm0%205L0%203h4L2%205z'/%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 10px center;
background-size: 12px;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
border-color: #8a4baf;
outline: none;
background-color: #fff;
}

.form-label {
font-weight: bold;
color: #4a1c2d;
margin-bottom: 4px;
display: block;
}

.checkbox-group {
display: flex;
flex-direction: column;
gap: 8px;
}

.checkbox-group input[type="checkbox"] {
width: 20px;
height: 20px;
margin: 0;
vertical-align: middle;
accent-color: #8a4baf;
}

.btn {
padding: 10px 20px;
background-color: #8a4baf;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
margin-top: 20px;
text-decoration: none;
display: inline-block;
}

.btn:hover {
background-color: #7b3d99;
}

.btn-danger {
background-color: #ff4444;
padding: 8px 15px;
font-size: 14px;
margin-top: 0;
}

.btn-danger:hover {
background-color: #cc0000;
}

.btn-edit {
background-color: #28a745;
padding: 8px 15px;
font-size: 14px;
margin-top: 0;
margin-right: 10px;
}

.btn-edit:hover {
background-color: #218838;
}

.btn-action {
padding: 8px 15px;
font-size: 14px;
margin-top: 0;
display: inline-block;
box-sizing: border-box;
width: 80px;
text-align: center;
}

.form-section {
background-color: #fff;
padding: 25px;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
margin-bottom: 30px;
}

.section-title {
font-size: 24px;
font-weight: bold;
color: #4a1c2d;
margin-bottom: 20px;
border-bottom: 2px solid #8a4baf;
padding-bottom: 10px;
}

.table {
width: 100%;
border-collapse: collapse;
background-color: #fff;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
border-radius: 8px;
overflow: hidden;
}

.table th,
.table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #ddd;
}

.table th {
background-color: #ffd1dc;
font-weight: bold;
color: #4a1c2d;
}

.table tbody tr:hover {
background-color: #f9f9f9;
}

.table tbody tr:nth-child(even) {
background-color: #f8f8f8;
}

.status-active {
color: #28a745;
font-weight: bold;
}

.status-inactive {
color: #dc3545;
font-weight: bold;
}

.discount-badge {
background-color: #8a4baf;
color: white;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
}

.coupon-code {
font-family: 'Courier New', monospace;
background-color: #f1f1f1;
padding: 4px 8px;
border-radius: 4px;
font-weight: bold;
}

.no-data-message {
text-align: center;
color: #666;
font-style: italic;
padding: 40px;
background-color: #f9f9f9;
border-radius: 8px;
}

.form-errors {
background-color: #ffe6e6;
border: 1px solid #ff4444;
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

.form-errors p {
color: #cc0000;
font-weight: bold;
margin-bottom: 10px;
}

.form-errors ul {
color: #cc0000;
margin-left: 20px;
}

.form-errors li {
margin-bottom: 5px;
}

.input-error {
border-color: #ff4444 !important;
background-color: #ffe6e6 !important;
}

.input-success {
border-color: #28a745 !important;
background-color: #e6ffe6 !important;
}
</style>

<!-- Create Coupon Form Section -->
<div class="form-section">
<h3 class="section-title">{% if form.instance.id %}Edit Coupon{% else %}Create New Coupon{% endif %}</h3>

{% if form.errors %}
<div class="form-errors">
<p>Please correct the following errors:</p>
<ul>
{% for field, errors in form.errors.items %}
{% for error in errors %}
<li>{{ field }}: {{ error }}</li>
{% endfor %}
{% endfor %}
</ul>
</div>
{% endif %}

<form method="post" class="form" id="coupon-form">
{% csrf_token %}

<div class="form-group">
<label class="form-label" for="id_code">Coupon Code:</label>
{{ form.code }}
</div>

<div class="form-group">
<label class="form-label" for="id_description">Description:</label>
{{ form.description }}
</div>

<div class="form-group">
<label class="form-label" for="id_coupon_type">Coupon Type:</label>
{{ form.coupon_type }}
</div>

<div class="form-group">
<label class="form-label" for="id_discount_value">Discount Value:</label>
{{ form.discount_value }}
</div>

<div class="form-group">
<label class="form-label" for="id_minimum_order_amount">Minimum Order Amount:</label>
{{ form.minimum_order_amount }}
</div>

<div class="form-group">
<label class="form-label" for="id_max_discount_amount">Maximum Discount Amount:</label>
{{ form.max_discount_amount }}
</div>

<div class="form-group">
<label class="form-label" for="id_valid_from">Valid From:</label>
{{ form.valid_from }}
</div>

<div class="form-group">
<label class="form-label" for="id_valid_until">Valid Until:</label>
{{ form.valid_until }}
</div>

<div class="form-group">
<label class="form-label" for="id_usage_limit">Usage Limit:</label>
{{ form.usage_limit }}
</div>

<div class="checkbox-group">
<label class="form-label" for="id_is_active">Is Active:</label>
{{ form.is_active }}
</div>

<button type="submit" name="create_coupon" class="btn">
{% if form.instance.id %}Update Coupon{% else %}Create Coupon{% endif %}
</button>
{% if form.instance.id %}
<a href="{% url 'manage_coupons' %}" class="btn btn-small" style="background-color: #6c757d; margin-left: 10px;">Cancel Edit</a>
{% endif %}
</form>
</div>

<!-- Existing Coupons Section -->
<div class="form-section">
<h3 class="section-title">Existing Coupons</h3>
{% if coupons %}
<table class="table">
<thead>
<tr>
<th>Code</th>
<th>Type</th>
<th>Discount</th>
<th>Min. Order Amount</th>
<th>Usage Limit</th>
<th>Valid From</th>
<th>Valid Until</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
{% for coupon in coupons %}
<tr>
<td><span class="coupon-code">{{ coupon.code }}</span></td>
<td>{{ coupon.get_coupon_type_display }}</td>
<td>
<span class="discount-badge">
{% if coupon.coupon_type == 'percentage' %}
{{ coupon.discount_value }}%
{% else %}
₹{{ coupon.discount_value }}
{% endif %}
</span>
</td>
<td>₹{{ coupon.minimum_order_amount|default:"0" }}</td>
<td>{{ coupon.usage_limit|default:"Unlimited" }}</td>
<td>{{ coupon.valid_from|date:"Y-m-d H:i" }}</td>
<td>{{ coupon.valid_until|date:"Y-m-d H:i" }}</td>
<td>
{% if coupon.is_valid %}
<span class="status-active">Active</span>
{% else %}
<span class="status-inactive">Inactive</span>
{% endif %}
</td>
<td>
<a href="{% url 'manage_coupons' %}?edit={{ coupon.id }}" class="btn btn-edit btn-action">Edit</a>
<form method="post" class="inline delete-form" data-coupon-code="{{ coupon.code }}" action="{% url 'delete_coupon' coupon.id %}">
{% csrf_token %}
<button type="submit" name="delete_coupon" class="btn btn-danger btn-action">
Delete
</button>
</form>
</td>
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
<div class="no-data-message">
<p>No coupons available. Create your first coupon using the form above.</p>
</div>
{% endif %}
</div>

<!-- JavaScript for SweetAlert2 and form validation -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const couponForm = document.getElementById('coupon-form');
    const deleteForms = document.querySelectorAll('.delete-form');

    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Show success/error messages if present
    {% if messages %}
    {% for message in messages %}
    Swal.fire({
        icon: '{{ message.tags }}' === 'success' ? 'success' : 'error',
        title: '{{ message.tags|title }}',
        text: '{{ message }}',
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 4000
    });
    {% endfor %}
    {% endif %}

    // Form validation for coupon creation/edit form
    couponForm.addEventListener('submit', function(e) {
        if (e.target.id !== 'coupon-form') return;

        let isValid = true;
        const inputs = couponForm.querySelectorAll('input[required], select[required], textarea[required]');

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('input-error');
                isValid = false;
            } else {
                input.classList.remove('input-error');
                input.classList.add('input-success');
            }
        });

        const discountValue = document.querySelector('#id_discount_value');
        if (discountValue && parseFloat(discountValue.value) <= 0) {
            discountValue.classList.add('input-error');
            isValid = false;
            Swal.fire({
                icon: 'error',
                title: 'Invalid Discount Value',
                text: 'Discount value must be greater than 0.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
            });
        }

        const couponCode = document.querySelector('#id_code');
        if (couponCode && couponCode.value.length < 3) {
            couponCode.classList.add('input-error');
            isValid = false;
            Swal.fire({
                icon: 'error',
                title: 'Invalid Coupon Code',
                text: 'Coupon code must be at least 3 characters long.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
            });
        }

        if (!isValid) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Form Validation Failed',
                text: 'Please correct the highlighted fields.',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
            });
        }
    });

    // Real-time validation
    couponForm.addEventListener('input', function(e) {
        const input = e.target;
        if (input.value.trim()) {
            input.classList.remove('input-error');
            input.classList.add('input-success');
        } else {
            input.classList.remove('input-success');
        }
    });

    // Delete confirmation with SweetAlert2
    deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const couponCode = form.dataset.couponCode;

            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete the coupon "${couponCode}". This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff4444',
                cancelButtonColor: '#8a4baf',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait while we delete the coupon.',
                        icon: 'info',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.close();
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: data.message,
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message || 'Failed to delete the coupon.',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 4000
                            });
                        }
                    })
                    .catch(error => {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: `An error occurred: ${error.message}`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 4000
                        });
                    });
                }
            });
        });
    });

    // Show form errors as toast if they exist
    {% if form.errors %}
    Swal.fire({
        icon: 'error',
        title: 'Form Errors',
        text: 'Please check the form for errors and try again.',
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 4000
    });
    {% endif %}
});
</script>

{% endblock %}