{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<section class="container mx-auto px-4 py-12">
<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow">
<h2 class="text-2xl font-bold text-purple-800 mb-6">Complete Your Payment</h2>

<div class="mb-6">
<p class="text-gray-600 mb-2">Order ID: {{ order.id }}</p>
<p class="text-gray-600 mb-2">Amount: â‚¹{{ order.total_amount|floatformat:2 }}</p>
</div>

<button id="rzp-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-md font-medium">
Pay Now
</button>

<p class="text-sm text-gray-500 mt-4">
You'll be redirected to Razorpay's secure payment page.
</p>
</div>
</section>

<!-- CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
var options = {
"key": "{{ razorpay_key }}",
"amount": "{{ razorpay_amount }}",
"currency": "{{ razorpay_currency }}",
"name": "Aura Scents",
"description": "Order Payment",
"image": "{% static 'images/logo.png' %}",
"order_id": "{{ razorpay_order_id }}",
"handler": function (response) {
// Submit the payment details to your server
var form = document.createElement('form');
form.method = 'POST';
form.action = "{{ callback_url }}";

var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
var csrfInput = document.createElement('input');
csrfInput.type = 'hidden';
csrfInput.name = 'csrfmiddlewaretoken';
csrfInput.value = csrfToken;
form.appendChild(csrfInput);

var paymentIdInput = document.createElement('input');
paymentIdInput.type = 'hidden';
paymentIdInput.name = 'razorpay_payment_id';
paymentIdInput.value = response.razorpay_payment_id;
form.appendChild(paymentIdInput);

var orderIdInput = document.createElement('input');
orderIdInput.type = 'hidden';
orderIdInput.name = 'razorpay_order_id';
orderIdInput.value = response.razorpay_order_id;
form.appendChild(orderIdInput);

var signatureInput = document.createElement('input');
signatureInput.type = 'hidden';
signatureInput.name = 'razorpay_signature';
signatureInput.value = response.razorpay_signature;
form.appendChild(signatureInput);

document.body.appendChild(form);
form.submit();
},
"prefill": {
"name": "{{ user.name }}",
"email": "{{ user.email }}",
"contact": "{{ user.contact }}"
},
"theme": {
"color": "#7c3aed"
},
"modal": {
"ondismiss": function() {
// Handle when user closes the payment modal
window.location.href = "{% url 'checkout' %}";
}
}
};

var rzp = new Razorpay(options);

// Open Razorpay automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
rzp.open();
});

// Also make the button work
document.getElementById('rzp-button').addEventListener('click', function(e) {
rzp.open();
e.preventDefault();
});
</script>
{% endblock %}