{% extends 'store/base.html' %}
{% load static %}

{% block title %}Product List | Aura Scents{% endblock %}

{% block content %}
<!-- Page Title -->
<section class="py-8 bg-gradient-to-r from-purple-50 to-white">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-playfair font-bold text-purple-900">Fragrance Products</h2>
    </div>
</section>

<!-- Product Listing Section -->
<section class="py-8">
    <div class="container mx-auto px-4">
        <form method="get" id="filters-form">
            <div class="flex flex-col md:flex-row">
                <!-- Sidebar (Filters Section) -->
                <div class="w-full md:w-1/4 pr-0 md:pr-8 mb-8 md:mb-0">
                    <!-- Product Categories Filter -->
                    <div class="mb-8">
                        <h3 class="text-lg font-playfair font-bold text-purple-900 mb-4">Product Categories</h3>
                        <ul class="space-y-2">
                            <li class="flex items-center">
                                <label>
                                    <input type="radio" name="category" value="" class="mr-2"
                                        onchange="document.getElementById('filters-form').submit()"
                                        {% if not category_id %}checked{% endif %}>
                                    All Categories
                                </label>
                            </li>
                            {% for category in categories %}
                            <li class="flex items-center">
                                <label>
                                    <input type="radio" name="category" value="{{ category.id }}" class="mr-2"
                                        onchange="document.getElementById('filters-form').submit()"
                                        {% if category.id|stringformat:"s" == category_id %}checked{% endif %}>
                                    {{ category.name }}
                                </label>
                            </li>
                            {% empty %}
                            <li class="text-gray-500">No categories available.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Price Filter -->
                    <div class="mb-8">
                        <h3 class="text-lg font-playfair font-bold text-purple-900 mb-4">Price Filter</h3>
                        <ul class="space-y-2">
                            <li class="flex items-center">
                                <input type="radio" name="price_range" value="" id="price-all" class="mr-2"
                                    onchange="document.getElementById('filters-form').submit();"
                                    {% if not min_price and not max_price %}checked{% endif %}>
                                <label for="price-all">All Price</label>
                            </li>
                            <li class="flex items-center">
                                <input type="radio" name="price_range" value="0-50" id="price-0-50" class="mr-2"
                                    onchange="document.getElementById('filters-form').submit();"
                                    {% if min_price == '0' and max_price == '50' %}checked{% endif %}>
                                <label for="price-0-50">₹0.00 - ₹50.00</label>
                            </li>
                            <li class="flex items-center">
                                <input type="radio" name="price_range" value="50-100" id="price-50-100" class="mr-2"
                                    onchange="document.getElementById('filters-form').submit();"
                                    {% if min_price == '50' and max_price == '100' %}checked{% endif %}>
                                <label for="price-50-100">₹50.00 - ₹100.00</label>
                            </li>
                            <li class="flex items-center">
                                <input type="radio" name="price_range" value="100-150" id="price-100-150" class="mr-2"
                                    onchange="document.getElementById('filters-form').submit();"
                                    {% if min_price == '100' and max_price == '150' %}checked{% endif %}>
                                <label for="price-100-150">₹100.00 - ₹150.00</label>
                            </li>
                            <li class="flex items-center">
                                <input type="radio" name="price_range" value="150-" id="price-150" class="mr-2"
                                    onchange="document.getElementById('filters-form').submit();"
                                    {% if min_price == '150' and not max_price %}checked{% endif %}>
                                <label for="price-150">₹150.00+</label>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="w-full md:w-3/4">
                    <!-- Top Section with Sort and Search -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div class="flex items-center mb-4 md:mb-0">
                            <span class="mr-2">Sort By:</span>
                            <select name="sort" onchange="document.getElementById('filters-form').submit();" class="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Default</option>
                                <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                                <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                                <option value="name_asc" {% if sort == 'name_asc' %}selected{% endif %}>Name: A–Z</option>
                                <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>Name: Z–A</option>
                            </select>
                        </div>
                        <div class="flex w-full md:w-auto">
                            <input
                                type="text"
                                name="q"
                                value="{{ query }}"
                                placeholder="Search products..."
                                class="border border-gray-300 rounded-l-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 w-full md:w-64"
                            >
                            <button type="submit" class="bg-purple-800 text-white px-4 py-2 rounded-r-md hover:bg-purple-900 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5atyku0a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Product Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        {% for product in page_obj %}
                        <div class="bg-purple-100 rounded-lg p-6 flex flex-col items-center text-center">
                            <a href="{% url 'product_detail' product.id %}">
                                {% if product.images.first %}
                                <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="h-40 object-contain mb-6">
                                {% else %}
                                <img src="{% static 'store/placeholder.svg' %}" alt="{{ product.name }}" class="h-40 object-contain mb-6">
                                {% endif %}
                            </a>
                            <h3 class="font-semibold text-lg text-purple-900">{{ product.name }}</h3>
                            <div class="text-base mb-4">
                                {% if product.discounted_price %}
                                <p class="text-purple-800 font-bold">₹{{ product.discounted_price|floatformat:2 }}</p>
                                <p class="text-gray-500 line-through">₹{{ product.display_price|floatformat:2 }}</p>
                                <p class="text-green-600 text-sm">
                                    {{ product.discount_percentage }}% off 
                                    ({{ product.offer_type|title }} Offer)
                                </p>
                                {% else %}
                                <p class="text-purple-800 font-bold">₹{{ product.display_price|floatformat:2 }}</p>
                                {% endif %}
                            </div>
                            <button class="add-to-cart-btn mt-auto bg-purple-600 text-white px-5 py-3 rounded hover:bg-purple-700 text-sm" data-product-id="{{ product.id }}">
                                Add to Cart
                            </button>
                        </div>
                        {% empty %}
                        <p class="text-purple-700 text-lg">No products available.</p>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    <div class="mt-10">
                        <nav class="flex justify-center">
                            <ul class="inline-flex -space-x-px">
                                {% if page_obj.has_previous %}
                                <li>
                                    <a href="?page={{ page_obj.previous_page_number }}&q={{ query }}&category={{ category_id }}&price_range={{ min_price }}{% if max_price %}-{{ max_price }}{% endif %}&sort={{ sort }}"
                                        class="px-3 py-2 ml-0 leading-tight text-purple-600 bg-white border border-purple-300 rounded-l-lg hover:bg-purple-100">Previous</a>
                                </li>
                                {% endif %}
                                {% for num in page_obj.paginator.page_range %}
                                <li>
                                    <a href="?page={{ num }}&q={{ query }}&category={{ category_id }}&price_range={{ min_price }}{% if max_price %}-{{ max_price }}{% endif %}&sort={{ sort }}"
                                        class="px-3 py-2 leading-tight {% if page_obj.number == num %}text-white bg-purple-600{% else %}text-purple-600 bg-white{% endif %} border border-purple-300 hover:bg-purple-100">
                                        {{ num }}
                                    </a>
                                </li>
                                {% endfor %}
                                {% if page_obj.has_next %}
                                <li>
                                    <a href="?page={{ page_obj.next_page_number }}&q={{ query }}&category={{ category_id }}&price_range={{ min_price }}{% if max_price %}-{{ max_price }}{% endif %}&sort={{ sort }}"
                                        class="px-3 py-2 leading-tight text-purple-600 bg-white border border-purple-300 rounded-r-lg hover:bg-purple-100">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- jQuery (required) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- SweetAlert2 (toast notifications) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- AJAX Scripts -->
<script>
$(document).ready(function () {
    // Add to Cart AJAX
    $('.add-to-cart-btn').on('click', function (e) {
        e.preventDefault();
        const productId = $(this).data('product-id');
        const $btn = $(this);
        const originalText = $btn.text();

        $.ajax({
            url: `/add-to-cart/${productId}/`,
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            success: function (response) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: response.status === 'success' ? 'success' : 'error',
                    title: response.message || 'Action completed!',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                });

                if (response.status === 'success') {
                    if (typeof response.cart_quantity !== 'undefined') {
                        const $cartCounter = $('#cart-counter');
                        if ($cartCounter.length) {
                            $cartCounter.text(response.cart_quantity);
                        }
                    }
                    // Update button text to show price was added
                    $btn.text(`Added ($${response.item_price})`);
                    setTimeout(() => {
                        $btn.text(originalText);
                    }, 2000);
                }
            },
            error: function (xhr) {
                const message = xhr.responseJSON?.message || 'Something went wrong!';
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: message,
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                });
            }
        });
    });

    // Helper: Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

{% endblock %}