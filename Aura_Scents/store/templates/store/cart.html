{% extends 'store/base.html' %}
{% load static %}

{% block title %}Aura Scents | Shopping Cart{% endblock %}

{% block content %}
<section class="container mx-auto px-4 py-12">
  <h2 class="text-3xl font-playfair font-bold text-purple-800 mb-8 text-center">Shopping Cart</h2>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left: Cart Items -->
    <div class="lg:col-span-2 space-y-6">
      {% if items %}
        {% for item in items %}
          <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow product-card" data-item-id="{{ item.id }}">
            <div class="flex items-center space-x-4">
              {% with item.product.images.first as product_image %}
                <a href="{% url 'product_detail' item.product.id %}">
                  {% if product_image %}
                    <img src="{{ product_image.image.url }}" alt="{{ item.product.name }}" class="w-20 h-20 rounded-lg border object-cover">
                  {% else %}
                    <img src="{% static 'img/placeholder.png' %}" alt="No image" class="w-20 h-20 rounded-lg border object-cover">
                  {% endif %}
                </a>
              {% endwith %}
              <div>
                <h4 class="text-lg font-semibold text-gray-800">
                  <a href="{% url 'product_detail' item.product.id %}" class="hover:underline">
                    {{ item.get_display_name }}
                  </a>
                </h4>
                <p class="text-sm text-gray-500">
                  Price: ₹{{ item.get_price }}
                  {% if item.variant %}
                    <span class="text-xs text-purple-600">({{ item.variant.volume }}{{ item.variant.unit }})</span>
                  {% endif %}
                </p>
                <p class="text-xs text-gray-400">
                  Available: {{ item.get_stock }} in stock
                </p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="flex items-center border border-gray-300 rounded-md">
                <button class="px-2 py-1 text-gray-600 hover:text-purple-700 decrement-btn" data-item-id="{{ item.id }}">-</button>
                <span class="px-3 quantity-display" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
                <button class="px-2 py-1 text-gray-600 hover:text-purple-700 increment-btn" data-item-id="{{ item.id }}">+</button>
              </div>
              <p class="w-24 text-center font-semibold text-gray-700 subtotal-display" data-item-id="{{ item.id }}">₹{{ item.subtotal }}</p>
              <button class="text-red-500 hover:text-red-700 remove-btn" data-item-id="{{ item.id }}">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-12">
          <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-4"></i>
          <p class="text-xl text-gray-500 mb-4">Your cart is empty</p>
          <a href="{% url 'products_page' %}" class="bg-purple-600 text-white px-6 py-3 rounded-full hover:bg-purple-700 transition duration-300">
            Continue Shopping
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Right: Summary -->
    <div class="bg-white p-6 rounded-lg shadow space-y-4">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h3>
      <div class="flex justify-between text-sm text-gray-700">
        <span>Subtotal</span>
        <span id="cart-total">₹{{ cart_total }}</span>
      </div>
      <p class="text-xs text-gray-500 mt-2">Shipping and taxes calculated at checkout.</p>

      <!-- Proceed to Checkout button -->
      <button
        id="checkout-btn"
        data-cart-empty="{% if not items %}true{% else %}false{% endif %}"
        class="w-full mt-4 bg-pink-500 hover:bg-pink-600 text-white py-2 px-4 rounded-md text-sm font-semibold
        {% if not items %}opacity-50 cursor-not-allowed{% endif %}"
        {% if not items %}disabled{% endif %}
      >
        Proceed to Checkout
      </button>

      {% if items %}
      <button id="clear-cart-btn" class="w-full mt-2 border border-gray-300 hover:bg-gray-100 py-2 px-4 rounded-md text-sm text-gray-700 font-medium">
        Clear Cart
      </button>
      {% endif %}
    </div>
  </div>
</section>

<!-- SweetAlert2 Toast -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  function showToast(message, type = 'error') {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: type,
      title: message,
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true
    });
  }

  function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-display').forEach(el => {
      const subtotal = parseFloat(el.textContent.replace('$', ''));
      if (!isNaN(subtotal)) {
        total += subtotal;
      }
    });
    document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    
    // Update checkout button state
    const checkoutBtn = document.getElementById('checkout-btn');
    const hasItems = document.querySelectorAll('.product-card').length > 0;
    
    if (!hasItems) {
      checkoutBtn.setAttribute('data-cart-empty', 'true');
      checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
      checkoutBtn.disabled = true;
    } else {
      checkoutBtn.setAttribute('data-cart-empty', 'false');
      checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      checkoutBtn.disabled = false;
    }
  }

  // Event listeners for increment/decrement buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('increment-btn')) {
      const itemId = e.target.dataset.itemId;
      updateCart(itemId, 'increment');
    } else if (e.target.classList.contains('decrement-btn')) {
      const itemId = e.target.dataset.itemId;
      updateCart(itemId, 'decrement');
    } else if (e.target.classList.contains('remove-btn') || e.target.parentElement.classList.contains('remove-btn')) {
      const button = e.target.classList.contains('remove-btn') ? e.target : e.target.parentElement;
      const itemId = button.dataset.itemId;
      removeFromCart(itemId);
    }
  });

  function updateCart(itemId, action) {
    // Disable buttons temporarily to prevent multiple clicks
    const incrementBtn = document.querySelector(`.increment-btn[data-item-id="${itemId}"]`);
    const decrementBtn = document.querySelector(`.decrement-btn[data-item-id="${itemId}"]`);
    
    if (incrementBtn) incrementBtn.disabled = true;
    if (decrementBtn) decrementBtn.disabled = true;

    fetch(`/update-cart/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({ action: action })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'success') {
        // Update quantity display
        const quantityEl = document.querySelector(`.quantity-display[data-item-id="${itemId}"]`);
        const subtotalEl = document.querySelector(`.subtotal-display[data-item-id="${itemId}"]`);
        
        if (quantityEl && subtotalEl) {
          quantityEl.textContent = data.new_quantity;
          subtotalEl.textContent = `$${data.new_subtotal.toFixed(2)}`;
          updateCartTotal();
        }
        
        showToast(data.message, 'success');
      } else {
        showToast(data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('An error occurred. Please try again.', 'error');
    })
    .finally(() => {
      // Re-enable buttons
      if (incrementBtn) incrementBtn.disabled = false;
      if (decrementBtn) decrementBtn.disabled = false;
    });
  }

  function removeFromCart(itemId) {
    Swal.fire({
      title: 'Remove Item?',
      text: "Are you sure you want to remove this item from your cart?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, remove it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/remove-from-cart/${itemId}/`, {
          method: 'POST',
          headers: { 
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            // Remove the item from DOM
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            if (itemElement) {
              itemElement.remove();
              updateCartTotal();
              
              // Check if cart is now empty
              if (document.querySelectorAll('.product-card').length === 0) {
                location.reload(); // Reload to show empty cart message
              }
            }
            showToast(data.message, 'success');
          } else {
            showToast(data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred. Please try again.', 'error');
        });
      }
    });
  }

  // Clear Cart AJAX
  document.getElementById('clear-cart-btn')?.addEventListener('click', function (e) {
    e.preventDefault();

    Swal.fire({
      title: 'Are you sure?',
      text: "This will remove all items from your cart.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, clear it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/clear-cart/', {
          method: 'POST',
          headers: { 
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: 'Cart cleared!',
              showConfirmButton: false,
              timer: 1500
            }).then(() => {
              location.reload();
            });
          } else {
            showToast(data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('An error occurred. Please try again.', 'error');
        });
      }
    });
  });

  // Proceed to Checkout button handler
  document.getElementById('checkout-btn')?.addEventListener('click', function () {
    const isCartEmpty = this.getAttribute('data-cart-empty') === 'true';

    if (isCartEmpty) {
      Swal.fire({
        icon: 'info',
        title: 'Cart is empty',
        text: 'Please add items to your cart before proceeding to checkout.',
        confirmButtonColor: '#a855f7'
      });
    } else {
      window.location.href = "{% url 'checkout' %}";
    }
  });
</script>
{% endblock %}