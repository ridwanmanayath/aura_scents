{% extends 'store/base.html' %}
{% load static %}

{% block title %}Manage Addresses - Aura Scents{% endblock %}

{% block content %}
<section class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
  <div class="container mx-auto flex gap-12">

    {% include 'store/user_sidebar.html' %}

    <!-- Main Content -->
    <div class="w-3/4 bg-white p-8 rounded-lg shadow-lg">
      <h2 class="text-3xl font-playfair font-bold text-purple-800 mb-6">Manage Addresses</h2>

      <!-- CSRF token for JS fetch() -->
      <form id="csrf-token-form">{% csrf_token %}</form>

      <!-- Address List -->
      <div class="space-y-6">
{% for address in addresses %}
<div class="border p-4 rounded-lg bg-gray-50 mb-4">
    <label class="flex items-center space-x-2">
        <input type="radio" name="selected_address" value="{{ address.id }}" class="text-purple-600" {% if forloop.first %}checked{% endif %} />
        <div>
            <p class="font-medium text-gray-800">{{ address.first_name }} {{ address.last_name }}</p>
            <p class="text-gray-700">{{ address.address }}, {{ address.city }}, {{ address.state }}, {{ address.pincode }}</p>
            <p class="text-gray-700">Mobile: {{ address.mobile_number }}</p>
            {% if address.alternate_mobile_number %}
            <p class="text-gray-700">Alternate: {{ address.alternate_mobile_number }}</p>
            {% endif %}
        </div>
    </label>
    <button type="button" onclick="openEditAddressModal({{ address.id }})" class="text-purple-600 hover:text-purple-800 text-sm mt-2">Edit</button>
</div>
{% empty %}
<p class="text-red-600">Please add a shipping address to proceed.</p>
{% endfor %}

        <!-- Add New Address Button -->
        <div class="mt-6 flex justify-center">
          <a href="{% url 'address_add' %}" class="bg-pink-500 hover:bg-pink-600 text-white py-2 px-6 rounded-md text-sm font-semibold">
            Add New Address
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- SweetAlert2 and fetch-based delete -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  function confirmDelete(addressId) {
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6B46C1',
      confirmButtonText: 'Yes, delete it!',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/address/${addressId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          }
        }).then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            Swal.fire('Error', 'Failed to delete the address.', 'error');
          }
        }).catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'An unexpected error occurred.', 'error');
        });
      }
    });
  }
</script>
{% endblock %}
